<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!--	（ログイン後）-->
	<title>英単語クイズ</title>

	<!-- Ocean テーマCSS -->
	<link rel="stylesheet" th:href="@{/css/ocean-theme.css}" />
	<link rel="stylesheet" th:href="@{/css/style.css}" />
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">

	<style>
		/* ログイン後クイズ特有の少しだけ追加スタイル */

		.home-link {
			/*margin-top: -10px;*/
			font-size: 0.9rem;
		}

		.home-link a {
			color: #0288d1;
			text-decoration: none;
		}

		.home-link a:hover {
			text-decoration: underline;
		}

		/* 選択肢ボタン（quiz.html のスタイルに合わせる） */
		.answers-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			margin-bottom: 25px;
		}

		.quiz-choice-btn.answer-btn {
			background: #ffffff;
			border: 2px solid #b3e5fc;
			border-radius: 12px;
			padding: 18px;
			font-size: 16px;
			color: #01579b;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 500;
			text-align: center;
		}

		.quiz-choice-btn.answer-btn:hover {
			background: #e0f7ff;
			border-color: #81d4fa;
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(33, 147, 176, 0.4);
		}

		.quiz-choice-btn.answer-btn.disabled {
			cursor: default;
			pointer-events: none;
			opacity: 0.9;
		}

		/* 正解・不正解（ocean-theme と合わせて優先度強化） */
		.quiz-choice-btn.answer-btn.quiz-choice-correct-clicked {
			background-color: #00bfa5 !important;
			border-color: #00bfa5 !important;
			color: #ffffff !important;
			font-weight: 700;
			text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.25);
		}

		.quiz-choice-btn.answer-btn.quiz-choice-wrong-clicked {
			background-color: #ff6f61 !important;
			border-color: #ff6f61 !important;
			color: #ffffff !important;
		}

		.quiz-choice-btn.answer-btn.quiz-choice-correct-answer {
			background-color: #00bfa5 !important;
			border-color: #00bfa5 !important;
			color: #ffffff !important;
			font-weight: 700;
			text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.25);
		}
		


		/* スマホ調整 */
		@media (max-width: 600px) {
			.quiz-container {
				padding: 24px;
				margin: 0 10px;
			}

			.question-text {
				font-size: 20px;
			}

			.quiz-choice-btn.answer-btn {
				padding: 14px;
				font-size: 14px;
			}

			.answers-grid {
				gap: 10px;
			}
		}
	</style>
</head>

<body>

	<!-- 共通ユーザーヘッダー（ナビゲーション） -->
	<div th:replace="~{fragments/user-header :: userHeader}"></div>

	<div class="content-wrap"><!--content-wrap-->

		<div class="quiz-container">

			<!-- ヘッダー -->
			<div class="header">
				<h1><img th:src="@{/images/flashcard_icon.png}" alt="icon">英単語クイズ</h1>
<!--				<p class="login-header-sub" th:if="${loginUser != null}">-->
<!--					ログイン中：<span th:text="${loginUser.name}">User Name</span>-->
<!--				</p>-->
<!--				<p class="home-link">-->
<!--					<a th:href="@{/user/home}">ユーザーHOMEへ戻る</a>-->
<!--				</p>-->
			</div>

			<!-- プログレスバー（デザイン統一のため設置） -->
			<div class="progress-bar">
				<div class="progress-fill"></div>
			</div>

			<!-- 問題文 -->
			<div class="question-section">
				<p class="question-text">
<!--					「<span th:text="${questionWord.english}">today</span>」の意味は？-->
					<span id="question-word" th:text="${questionWord.english}">today</span>
				</p>
				
				<button type="button" onclick="speakElement('#question-word')"
					style="width: 7%;
				    		border: none;
				    		background-color: transparent;
							position: absolute;
							right: 18px;
							bottom: 11px;">
					<span><img class="onsei-img" th:src="@{/images/icon_onsei_1.png}" style="width: 100%;"></span>
				</button>
				
			</div>

			<!-- 正解の日本語（JavaScript参照用） -->
			<input type="hidden" id="correctJapanese" th:value="${correctJapanese}" />

			<!-- 選択肢 -->
			<div class="answers-grid" id="choices-container">
				<button type="button" class="quiz-choice-btn answer-btn" th:each="choice : ${choices}"
					th:text="${choice}" th:attr="data-choice=${choice}">
					サンプル選択肢
				</button>
			</div>

			<!-- 不正解時のみ表示する「次へ」 -->
			<div class="quiz-next-wrapper">
				<button id="nextButton" class="quiz-next-button" type="button" style="display: none;">
					次へ
				</button>
			</div>
		</div>
		

		
	</div><!--content-wrap-->

	<!-- JS：クリック判定 -->
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const correctJapanese = document.getElementById("correctJapanese").value;
			const choiceButtons = document.querySelectorAll(".quiz-choice-btn");
			const nextButton = document.getElementById("nextButton");

			let answered = false;

			choiceButtons.forEach(function (btn) {
				btn.addEventListener("click", function () {
					if (answered) return;
					answered = true;

					const selected = btn.getAttribute("data-choice");

					// 多重クリック禁止
					choiceButtons.forEach((b) => b.classList.add("disabled"));

					if (selected === correctJapanese) {
						// 正解
						
						playCorrectSound();   // 正解音
						
						btn.classList.add("quiz-choice-correct-clicked");

						setTimeout(() => {
							window.location.href = "/user/quiz";
						}, 1500);

					} else {
						// 不正解
						
						playWrongSound();     // 不正解音
						
						btn.classList.add("quiz-choice-wrong-clicked");

						choiceButtons.forEach((b) => {
							if (b.getAttribute("data-choice") === correctJapanese) {
								b.classList.add("quiz-choice-correct-answer");
							}
						});

						nextButton.style.display = "inline-block";
						nextButton.addEventListener("click", function () {
							window.location.href = "/user/quiz";
						});
					}
				});
			});
		});
		
		
		{
			// tts.js
			// 指定したセレクタの要素内テキストを読み上げる関数

			function speakElement(selector) {
			  // ブラウザが TTS に対応しているかチェック
			  if (!('speechSynthesis' in window)) {
			    alert('このブラウザは読み上げに対応していません');
			    return;
			  }

			  const el = document.querySelector(selector);
			  if (!el) {
			    console.warn('要素が見つかりません: ' + selector);
			    return;
			  }

			  // タグの中の文字だけを取得（HTMLタグは除外）
			  const text = el.textContent.trim();
			  if (!text) {
			    console.warn('読み上げるテキストがありません');
			    return;
			  }

			  // 前の読み上げが残っていたら止める
			  speechSynthesis.cancel();

			  const utterance = new SpeechSynthesisUtterance(text);
			  utterance.lang = 'en-US'; // 英語
			  utterance.rate = 0.9;     // 速度（お好みで調整可）

			  speechSynthesis.speak(utterance);
			}
		}
	</script>
	
	<!-- クイズ正誤音 -->
	<audio id="correctSound" th:src="@{/sounds/correct.mp3}"></audio>
	<audio id="wrongSound" th:src="@{/sounds/wrong.mp3}"></audio>
	<script th:src="@{/js/quiz-sound.js}"></script>
	<script th:src="@{/js/hamburger.js}"></script>
</body>

</html>