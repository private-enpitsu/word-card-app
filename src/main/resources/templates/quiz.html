<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>英単語クイズ</title>

	<link rel="stylesheet" th:href="@{/css/ocean-theme.css}">
	<link rel="stylesheet" th:href="@{/css/style.css}" />
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">

</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y8KFWJEH58"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y8KFWJEH58');
</script>

<body>


	<!--
	    ユーザー共通ヘッダー（ログイン後画面用）
	    - ログイン中ユーザー名の表示
	    - 画面上部のナビゲーションメニュー
	    - デザインは Ocean テーマに合わせた、シンプルな水平メニュー
	    - スマホでは横幅が足りなくなったら自然に折り返す（ハンバーガー無し）
	  -->


	<div th:fragment="userHeader">

		<style>
			div .user-header {
				display: flex;
				flex-wrap: wrap;
				justify-content: space-between;
				align-items: center;
				gap: 8px 16px;
				padding: 18px 27px;
				/* 		box-shadow: 0 1px 5px rgba(0, 0, 0, 0.12); */
				font-size: 0.9rem;
				position: absolute;
				width: 100%;
				min-height: 94px;
			}
		</style>

		<div class="user-header"><!--header-->
			<div style="display: flex; flex-direction: column; gap: 4px;">
				<span>
					<a th:href="@{/}" style="color: #fff; font-size: 1.3rem; text-decoration: none;">
						FLASHCARD
					</a>
				</span>
			</div>

			<nav><!-- 右側：ナビゲーションメニュー -->
			</nav>
		</div>
	</div>



	<div class="content-wrap"><!--content-wrap-->
		<div class="quiz-container">
			<!-- ヘッダー（タイトルなど） -->
			<div class="header">
				<h1><img th:src="@{/images/free_icon60.png}" alt="icon">英単語クイズ</h1>
<!--				<p>次の英単語の意味として正しいものを1つ選んでください。</p>-->
			</div>

			<!-- プログレスバー（現時点では見た目のみ） -->
			<div class="progress-bar">
				<div class="progress-fill"></div>
			</div>

			<!-- 問題文表示エリア -->
			<div class="question-section">
				<p class="question-text">
					<span id="question-word" th:text="${questionWord.english}">today</span>
				</p>

				<button type="button" onclick="speakElement('#question-word')" style="width: 7%;
				    		border: none;
				    		background-color: transparent;
							position: absolute;
							right: 18px;
							bottom: 11px;">
					<span><img class="onsei-img" th:src="@{/images/icon_onsei_1.png}" style="width: 100%;"></span>
				</button>


			</div>

			<!-- ★ 正解の日本語（JS 判定用） -->
			<input type="hidden" id="correctJapanese" th:value="${correctJapanese}" />

			<!-- 選択肢（2列グリッドで配置） -->
			<div class="answers-grid" id="choices-container">
				<!--
        th:each で 4 つの選択肢を繰り返し表示する。
        data-choice に、その選択肢の値（日本語）を埋め込んでおく。
        JS は従来どおり class="quiz-choice-btn" を基準に動作する。
      -->
				<button type="button" class="answer-btn quiz-choice-btn" th:each="choice : ${choices}"
					th:text="${choice}" th:attr="data-choice=${choice}">
					サンプル選択肢
				</button>
			</div>

			<!-- 不正解時のみ表示する「次へ」ボタン -->
			<div class="quiz-next-wrapper">
				<button id="nextButton" class="quiz-next-button" type="button" style="display: none;">
					次へ
				</button>
			</div>
		</div>
	</div>

	<!-- ★ クイズ用の JavaScript（ロジックは従来どおり） -->
	<script>
		// ページの読み込みが完了したら処理を開始
		document.addEventListener("DOMContentLoaded", function () {
			// 正解の日本語（hidden の値）
			const correctJapaneseInput = document.getElementById("correctJapanese");
			const correctJapanese = correctJapaneseInput ? correctJapaneseInput.value : "";

			// 4つの選択肢ボタン
			const choiceButtons = document.querySelectorAll(".quiz-choice-btn");

			// 「次へ」ボタン
			const nextButton = document.getElementById("nextButton");

			// 1問につき最初の1クリックだけを有効にするためのフラグ
			let answered = false;

			choiceButtons.forEach(function (btn) {
				btn.addEventListener("click", function () {
					// すでに回答済みなら何もしない（多重クリック防止）
					if (answered) {
						return;
					}
					answered = true;

					// クリックされた選択肢の値
					const selected = btn.getAttribute("data-choice");

					// すべての選択肢ボタンのクリックを無効化（見た目もクリック不可に）
					choiceButtons.forEach(function (b) {
						b.classList.add("disabled");
					});

					if (selected === correctJapanese) {

						playCorrectSound();   // 正解音

						// ★ 正解をクリックした場合：
						//   - クリックしたボタンを正解色にする
						//   - 1.5秒後に次の問題へ（/quiz へ遷移）
						btn.classList.add("quiz-choice-correct-clicked");

						setTimeout(function () {
							// 次の問題を表示（GET /quiz）
							window.location.href = "/quiz";
						}, 1500);
					} else {

						playWrongSound();     // 不正解音

						// ★ 不正解をクリックした場合：
						//   - クリックしたボタンを不正解色に
						//   - 正解のボタンを正解色に
						//   - 「次へ」ボタンを表示し、ユーザー操作を待つ
						btn.classList.add("quiz-choice-wrong-clicked");

						// 正解の選択肢にだけ「正解」のクラスを付ける
						choiceButtons.forEach(function (b) {
							const value = b.getAttribute("data-choice");
							if (value === correctJapanese) {
								b.classList.add("quiz-choice-correct-answer");
							}
						});

						// 「次へ」ボタンを表示して、ユーザーの操作を待つ
						if (nextButton) {
							nextButton.style.display = "inline-block";

							nextButton.addEventListener("click", function () {
								// 次の問題を表示（GET /quiz）
								window.location.href = "/quiz";
							});
						}
					}
				});
			});
		});


		{
			// tts.js
			// 指定したセレクタの要素内テキストを読み上げる関数

			function speakElement(selector) {
				// ブラウザが TTS に対応しているかチェック
				if (!('speechSynthesis' in window)) {
					alert('このブラウザは読み上げに対応していません');
					return;
				}

				const el = document.querySelector(selector);
				if (!el) {
					console.warn('要素が見つかりません: ' + selector);
					return;
				}

				// タグの中の文字だけを取得（HTMLタグは除外）
				const text = el.textContent.trim();
				if (!text) {
					console.warn('読み上げるテキストがありません');
					return;
				}

				// 前の読み上げが残っていたら止める
				speechSynthesis.cancel();

				const utterance = new SpeechSynthesisUtterance(text);
				utterance.lang = 'en-US'; // 英語
				utterance.rate = 0.9;     // 速度（お好みで調整可）

				speechSynthesis.speak(utterance);
			}
		}

	</script>


	<!-- クイズ正誤音 -->
	<audio id="correctSound" th:src="@{/sounds/correct.mp3}"></audio>
	<audio id="wrongSound" th:src="@{/sounds/wrong.mp3}"></audio>
	<script th:src="@{/js/quiz-sound.js}"></script>
</body>

</html>